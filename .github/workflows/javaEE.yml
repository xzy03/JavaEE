name: JavaEE Controller Tests

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'src/test/java/cn/edu/zjut/controller/**'  # 仅监控controller测试目录
      - 'pom.xml'                                 # 依赖变更也会影响测试
  pull_request:
    branches: [ "main", "develop" ]
    paths:
      - 'src/test/java/cn/edu/zjut/controller/**'
      - 'pom.xml'
  workflow_dispatch:   # 允许手动触发

jobs:
  controller-tests:
    name: Run Controller Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        test-class: [
          "AdminsControllerTest",
          "ContractsControllerTest",
          "HouseControllerTest",
          "LandlordControllerTest",
          "TenantControllerTest"
        ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 优化检出性能

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.m2
            target/
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run specific test (${{ matrix.test-class }})
        run: |
          mvn test -Dtest="cn.edu.zjut.controller.${{ matrix.test-class }}" -B
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: Upload test report for ${{ matrix.test-class }}
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-report-${{ matrix.test-class }}
          path: target/surefire-reports/TEST-cn.edu.zjut.controller.${{ matrix.test-class }}.xml